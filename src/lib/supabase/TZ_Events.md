
## 1. КОНТЕКСТ ПРОЕКТА (всегда включать)

### Описание проекта
AI-ассистент для владельцев домашних животных - petvizor

### Текущая архитектура БД (Supabase)
- **users** - базовая информация о пользователях для идентификации и входа
- **profiles** - контактная информация пользователей  
- **pets** - данные о питомцах (связь: один пользователь → много питомцев)
- **chat_messages** - сообщения в чате с AI-ассистентом (связь с users)
- **scans** - QR-коды питомцев и адреса публичных страниц (связь с pets)
- **breeds_dog** - справочник пород собак (пока не связан, планируется связь с pets)
- **events** - события питомцев (вакцинация, день рождения) - связь с pets и users
- **notifications** - уведомления о событиях - связь с events

### Стек технологий
- Backend: Node.js
- Frontend: TypeScript
- База данных: Supabase (PostgreSQL)
- Хостинг: Vercel

---

## 2. ПЛАНИРОВАНИЕ НОВОГО МОДУЛЯ

### A. АНАЛИЗ ДАННЫХ
**Вопросы для заполнения:**
- С какими данными будем работать? (существующие таблицы / новые таблицы)
- Какие данные хотим получить на выходе?
- Как новые данные связаны с существующими таблицами?
- Нужны ли новые поля в существующих таблицах?

**Мой анализ для задачи СИСТЕМА СОБЫТИЙ И УВЕДОМЛЕНИЙ:**
```
СУЩЕСТВУЮЩИЕ ДАННЫЕ:
- pets (питомцы) - к ним привязываются события
- users (пользователи) - получают уведомления о событиях

НОВЫЕ ДАННЫЕ:
- Таблица events с полями:
  * event_type (тип события: вакцинация, день рождения)  
  * pet_id (связь с питомцем)
  * user_id (связь с владельцем)
  * event_name (название события)
  * event_description (описание)
  * event_date (дата события)
  * notification_days_before (за сколько дней уведомлять)
  * event_status (произошло/не произошло)
  * notification_active (включено/выключено уведомление)

- Таблица notifications с полями:
  * event_id (связь с событием)
  * notification_type (push, email, sms)
  * notification_date (дата отправки уведомления)
  * notification_status (отправлено/не отправлено)

ВЫХОДНЫЕ ДАННЫЕ:
- Список событий питомца
- Активные уведомления для пользователя
- История уведомлений
```

### B. ЛОГИКА ОБРАБОТКИ  
**Вопросы для заполнения:**
- Какая логика обработки данных нужна?
- Где будет выполняться обработка? (фронтенд / бэкенд / база данных)
- Нужны ли триггеры, периодические задачи, внешние API?
- Как модуль взаимодействует с существующими функциями?

**Мой анализ для задачи СИСТЕМА СОБЫТИЙ И УВЕДОМЛЕНИЙ:**
```
ЛОГИКА ОБРАБОТКИ:
- Создание/редактирование событий через веб-интерфейс
- Периодическая проверка в коде приложения (каждый час) - поиск событий, по которым пора отправлять уведомления
- Вычисление даты уведомления: event_date минус notification_days_before
- Создание записи в таблице notifications при наступлении времени уведомления
- Отправка уведомления пользователю (пока только показ в интерфейсе)

МЕСТО ВЫПОЛНЕНИЯ:
- Фронтенд: интерфейс управления событиями
- Бэкенд: API для работы с событиями и проверка времени уведомлений
- Клиентская часть: отображение уведомлений

ВЗАИМОДЕЙСТВИЕ С СУЩЕСТВУЮЩИМИ ФУНКЦИЯМИ:
- Интеграция с профилем питомца (показ событий)
- Использование существующей авторизации пользователей
```

### C. ПОЛЬЗОВАТЕЛЬСКИЙ ИНТЕРФЕЙС
**Вопросы для заполнения:**
- Как пользователь будет взаимодействовать с функцией?
- На какой странице разместить интерфейс?
- Какие действия доступны пользователю? (создать/редактировать/удалить/просмотр)
- Как будет выглядеть результат для пользователя?

**Мой анализ для задачи СИСТЕМА СОБЫТИЙ И УВЕДОМЛЕНИЙ:**
```
ВЗАИМОДЕЙСТВИЕ ПОЛЬЗОВАТЕЛЯ:
- На странице питомца: блок "События" с кнопкой перехода
- Отдельная страница "События питомца" с функциями:
  * Просмотр списка всех событий
  * Создание нового события (форма с полями)
  * Редактирование существующих событий
  * Удаление событий

РАЗМЕЩЕНИЕ В ИНТЕРФЕЙСЕ:
- Страница питомца: новый блок "События" в профиле
- Отдельная страница: /pet/{id}/events
- Профиль пользователя: значок колокольчика с количеством активных уведомлений

РЕЗУЛЬТАТ ДЛЯ ПОЛЬЗОВАТЕЛЯ:
- Видит все важные события своего питомца
- Получает напоминания заранее (за N дней)
- Может планировать уход за питомцем
```

### D. АРХИТЕКТУРНЫЕ ТРЕБОВАНИЯ
**Вопросы для заполнения:**
- Влияет ли решение на производительность?
- Нужно ли учитывать масштабирование?
- Есть ли ограничения или требования безопасности?
- Как решение повлияет на существующий код?

**Мой анализ для задачи СИСТЕМА СОБЫТИЙ И УВЕДОМЛЕНИЙ:**
```
ПРОИЗВОДИТЕЛЬНОСТЬ:
- События создаются редко, нагрузка на запись минимальная  
- Проверка уведомлений - периодическая задача, не влияет на пользовательский опыт
- Количество событий на питомца ограничено (десятки записей)

МАСШТАБИРОВАНИЕ:
- При росте до 10,000 пользователей система останется эффективной
- Возможно потребуется оптимизация периодической проверки

БЕЗОПАСНОСТЬ:
- Пользователь видит только события своих питомцев
- Стандартная авторизация через существующую систему users

ВЛИЯНИЕ НА СУЩЕСТВУЮЩИЙ КОД:
- Минимальное - добавляются новые таблицы и страницы
- Не затрагивает существующую логику авторизации и профилей
```

---

## 3. РАЗБИВКА НА ЭТАПЫ

### Принципы разбивки:
- Каждый этап должен давать тестируемый результат
- Начинать с данных, затем логика, затем интерфейс
- Максимум 4-5 этапов для одного модуля

### Этапы для задачи СИСТЕМА СОБЫТИЙ И УВЕДОМЛЕНИЙ:

**Этап 1: Создание таблицы событий**
- Результат: В БД появляется таблица events с правильными связями, можно добавлять события через БД

**Этап 2: Интерфейс управления событиями**  
- Результат: На сайте есть страница событий питомца, можно создавать/редактировать/удалять события

**Этап 3: Создание таблицы уведомлений**
- Результат: В БД появляется таблица notifications, готовая к работе с событиями

**Этап 4: Логика проверки и создания уведомлений**
- Результат: Система автоматически создает уведомления в БД по расписанию

**Этап 5: Отображение уведомлений пользователю**
- Результат: В профиле появляется колокольчик с количеством уведомлений

---

## 4. ТЗ ДЛЯ CURSOR (готовое к копированию)

### Этап 1: Создание таблицы событий

**Контекст проекта:**
Проект: AI-ассистент для владельцев домашних животных - petvizor.vercel.app
Стек: Node.js + TypeScript + Supabase + Vercel

Текущие таблицы в БД:
- users - базовая информация о пользователях для идентификации и входа
- profiles - контактная информация пользователей  
- pets - данные о питомцах (связь: один пользователь → много питомцев)
- chat_messages - сообщения в чате с AI-ассистентом (связь с users)
- scans - QR-коды питомцев и адреса публичных страниц (связь с pets)
- breeds_dog - справочник пород собак (пока не связан)

**Задача:**
Создать таблицу events для хранения событий питомцев (вакцинация, день рождения).

**Технические требования:**
- Таблица events с полями:
  * id (primary key)
  * pet_id (foreign key → pets.id)
  * user_id (foreign key → users.id) 
  * event_type (varchar) - тип события: "вакцинация", "день рождения"
  * event_name (varchar) - название события
  * event_description (text) - описание события
  * event_date (date) - дата события
  * notification_days_before (integer) - за сколько дней уведомлять (например, 7)
  * event_status (boolean) - произошло событие или нет (default: false)
  * notification_active (boolean) - включено ли уведомление (default: true)
  * created_at (timestamp)
  * updated_at (timestamp)

- Обязательные связи: pet_id и user_id должны быть foreign keys
- Индексы на pet_id и user_id для быстрого поиска

**Ожидаемый результат:**
Таблица создана в Supabase, можно добавить тестовое событие через админку БД, связи работают корректно.

---

## 5. ЧЕКЛИ СТ ПОСЛЕ РАБОТЫ С CURSOR

После выполнения этапа проверить:
- [ ] Код работает без ошибок локально
- [ ] Код успешно деплоится на Vercel  
- [ ] Новые таблицы корректно связаны с существующими
- [ ] Функционал работает согласно ТЗ
- [ ] Обновить раздел "Текущая архитектура БД" в этом документе

**Заметки по этапу:**
```
[Записать проблемы, решения, важные моменты для следующих этапов]
```

---

## ИСТОРИЯ МОДУЛЕЙ

### 2024-08-20 - Система событий и уведомлений
- Статус: В работе (Этап 2 завершен)
- Особенности реализации: Используем периодическую проверку в коде вместо DB триггеров, связь событий и с pets и с users для безопасности
- Ссылки: 
                * API: `/api/events` - создание и получение событий
              * API: `/api/events/[id]` - обновление и удаление событий
              * Страница: `/events` - управление всеми событиями пользователя
              * Компонент: `PetEvents` - блок событий на странице питомца
              * Страница: `/pet/[id]/events` - управление событиями питомца

---

*Версия шаблона: 1.0*  
*Последнее обновление: [ДАТА]*